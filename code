import gradio as gr
import torch
from torchvision import transforms, models
from PIL import Image
import requests

# ImageNet sÄ±nÄ±f etiketlerini almak iÃ§in
def get_imagenet_labels():
    url = "https://raw.githubusercontent.com/pytorch/hub/master/imagenet_classes.txt"
    response = requests.get(url)
    labels = response.text.splitlines()
    return labels

# ResNet50 modelini yÃ¼kle
def load_resnet_model():
    model = models.resnet50(pretrained=True)
    model.eval()  # Modeli deÄŸerlendirme modunda ayarla
    return model

# GÃ¶rÃ¼ntÃ¼ Ã¶n iÅŸleme fonksiyonu
def preprocess_image(image):
    # GÃ¶rÃ¼ntÃ¼leri 224x224 boyutuna kÃ¼Ã§Ã¼lt
    preprocess = transforms.Compose([
        transforms.Resize(256),
        transforms.CenterCrop(224),
        transforms.ToTensor(),
        transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
    ])
    input_tensor = preprocess(image)
    input_batch = input_tensor.unsqueeze(0)
    return input_batch

# SÄ±nÄ±flandÄ±rma ve sonuÃ§larÄ± alma
def classify_with_resnet(image):
    # GÃ¶rÃ¼ntÃ¼yÃ¼ iÅŸleme
    input_batch = preprocess_image(image)
    
    # Modeli yÃ¼kle
    model = load_resnet_model()
    
    # Modeli Ã§alÄ±ÅŸtÄ±r
    with torch.no_grad():
        output = model(input_batch)
        probabilities = torch.nn.functional.softmax(output[0], dim=0)
    
    # En yÃ¼ksek 5 olasÄ±lÄ±ÄŸÄ± al
    top5_prob, top5_catid = torch.topk(probabilities, 5)
    
    # ImageNet etiketlerini al
    imagenet_labels = get_imagenet_labels()
    
    # Sadece hayvan sÄ±nÄ±flarÄ±na odaklanalÄ±m
    animal_keywords = ["dog", "cat", "horse", "bird", "fish", "rabbit", "hamster", "turtle", "elephant", "cow", "sheep", "goat", "duck", "hen", "lion", "tiger", "bear", "panda"]
    
    filtered_results = []
    for i in range(5):
        label_index = top5_catid[i].item()
        label = imagenet_labels[label_index]
        
        # EÄŸer sÄ±nÄ±f hayvan kategorisindeyse, sonuca ekle
        if any(animal in label.lower() for animal in animal_keywords):
            prob = top5_prob[i].item() * 100
            filtered_results.append(f"{label}: {prob:.2f}%")
    
    if filtered_results:
        top_class = filtered_results[0]  # En yÃ¼ksek ihtimalli hayvan sÄ±nÄ±fÄ±
        return top_class, "\n".join(filtered_results)
    else:
        return "Bu gÃ¶rsel bir hayvan iÃ§ermiyor.", "Hayvan sÄ±nÄ±fÄ± bulunamadÄ±."

# Gradio arayÃ¼zÃ¼
def create_interface():
    with gr.Blocks() as interface:
        gr.Markdown("# ğŸ¶ Hayvan SÄ±nÄ±flandÄ±rÄ±cÄ±")
        gr.Markdown("YÃ¼klediÄŸiniz hayvan fotoÄŸraflarÄ±nÄ± yapay zeka ile sÄ±nÄ±flandÄ±rabilirsiniz.")
        
        with gr.Row():
            with gr.Column():
                # GiriÅŸ bileÅŸenleri
                image_input = gr.Image(type="pil", label="Bir gÃ¶rÃ¼ntÃ¼ yÃ¼kleyin")
                classify_btn = gr.Button("SÄ±nÄ±flandÄ±r")
                
            with gr.Column():
                # Ã‡Ä±ktÄ± bileÅŸenleri
                top_class = gr.Textbox(label="En OlasÄ± SÄ±nÄ±f")
                result_output = gr.Textbox(label="Ä°lk 5 SÄ±nÄ±f Sonucu", lines=5)
        
        # Buton tÄ±klandÄ±ÄŸÄ±nda sÄ±nÄ±flandÄ±rma iÅŸlemini gerÃ§ekleÅŸtir
        classify_btn.click(
            fn=classify_with_resnet,
            inputs=[image_input],
            outputs=[top_class, result_output]
        )
    
    return interface

# UygulamayÄ± baÅŸlat
if __name__ == "__main__":
    interface = create_interface()
    interface.launch(share=True)  # Share=True ile internet Ã¼zerinden eriÅŸilebilir hale gelir
